<div class="panel-note-detail" [class.minimize]="!maximize" [class.maximize]="maximize">
    <div class="header-panel">
        <div class="pic-title-text">
            <div class="note-icon">
                <span class="material-icons">note</span>
            </div>
            <div class="title-text">
                <h3>{{ 'CDSCanvas.NoteDetails' | translate }}</h3>
            </div>
        </div>
        <!-- <div class="header-options-wrp icon-action" (click)="onChangeMaximize()">
            <img *ngIf="!maximize" src="assets/images/icons/fold.svg" class="active-icon" [title]="'Maximize' | translate" alt="">
            <img *ngIf="maximize" src="assets/images/icons/unfold.svg" class="active-icon" [title]="'Minimize' | translate" alt="">
        </div> -->
        <div class="header-menu-wrp icon-action" [matMenuTriggerFor]="noteMenu">
            <mat-icon class="active-icon" svgIcon="more_horiz" aria-hidden="true"></mat-icon>
        </div>
        <div class="header-close-wrp icon-action" (click)="onClosePanel()">
            <mat-icon class="active-icon" svgIcon="close" aria-hidden="true"></mat-icon>
        </div>
    </div>
    <div id="content-panel" class="content-panel">

        <!-- IMAGE NOTE (solo pannello upload + preview) -->
        <div class="row image-note-section" *ngIf="note?.type === 'image'">
            <!-- stato: nessuna immagine ancora -->
            <div *ngIf="!hasImage || isReplacingImage" class="image-upload-box"
                 (drop)="onImageDrop($event)"
                 (dragover)="onImageDragOver($event)">

                <input #imageFileInput type="file" accept="image/*" class="image-file-input" (change)="onImageFileSelected($event)" />

                <div class="image-upload-hint">
                    Drag & drop an image, click upload, or paste a link.
                </div>

                <div class="image-upload-actions">
                    <button type="button" class="image-btn" [disabled]="isUploadingImage" (click)="triggerImageFilePicker()">carica</button>
                </div>

                <div class="image-url-row">
                    <input class="image-url-input" type="text" [(ngModel)]="imageUrlInput" [disabled]="isUploadingImage" placeholder="https://..." />
                    <button type="button" class="image-btn" [disabled]="isUploadingImage" (click)="onImageUrlSubmit()">add</button>
                </div>

                <loading-spinner *ngIf="isUploadingImage" class="custom-spinner"></loading-spinner>
                <div *ngIf="imageUploadError" class="image-upload-error">{{ imageUploadError }}</div>
            </div>

            <!-- stato: immagine presente -->
            <div *ngIf="hasImage && !isReplacingImage" class="image-preview-box">
                <div class="image-preview-frame">
                    <div class="image-preview-placeholder" *ngIf="!imagePreviewLoaded"></div>
                    <img class="image-preview"
                         [src]="imageSrc"
                         alt="note image"
                         (load)="onImagePreviewLoad()"
                         (error)="onImagePreviewError()" />
                </div>
    
                <div class="image-dimensions">Original image size (in pixels): {{ imageNaturalWidth }}px Ã— {{ imageNaturalHeight }}px</div>

                <div class="image-buttons">
                    <button type="button" class="image-btn" (click)="onReplaceImage()">Replace</button>
                    <button type="button" class="image-btn danger" (click)="onDeleteNote()">Remove</button>
                </div>
            </div>
        </div>
        
        <!-- ---------------------------------------------------------- -->
        <!-- Rich Text Editor Section -->
        <!-- ---------------------------------------------------------- -->
        <div class="row rich-text-editor-section" *ngIf="note?.type === 'text' || !note?.type">
            <!-- <div class="section-header">
                <h4 class="section-title">Markup text</h4>
                <mat-icon class="more-options-icon" svgIcon="more_vert" aria-hidden="true"></mat-icon>
            </div> -->
            <quill-editor 
            #quillEditor
            [(ngModel)]="note.text"
            [modules]="quillModules"
            (onContentChanged)="onQuillContentChanged($event)"
            [styles]="{ height: '150px' }">
          </quill-editor>

        </div>


        <div class="row background-section" *ngIf="note?.type !== 'image'">
            <!-- ---------------------------------------------------------- -->
            <!-- Background color Section -->
            <!-- ---------------------------------------------------------- -->
        
            <div class="section-header">
                <h4 class="section-title">Background color</h4>
                <mat-icon class="collapse-icon" svgIcon="remove" aria-hidden="true"></mat-icon>
            </div>

            <div class="color-control-group">
                <div class="color-swatch-wrapper">
                    <input type="color" 
                        class="color-swatch" 
                        [value]="getBaseColorForPicker('background')"
                        (input)="onColorInput($event, 'background', note.backgroundOpacity)"
                        (change)="onColorChange($event, 'background', note.backgroundOpacity)">
                </div>
                <div class="slider-wrapper">
                    <input type="range" 
                        class="opacity-slider" 
                        min="0" 
                        max="100" 
                        [(ngModel)]="note.backgroundOpacity"
                        (input)="onFormatChange()">
                </div>
                <input type="text" 
                    class="opacity-input" 
                    [ngModel]="note.backgroundOpacity"
                    (ngModelChange)="onOpacityInputChange('background', $event)"
                    (input)="onOpacityInput($event, 'background')"
                    (blur)="onOpacityInputBlur('background')"
                    pattern="[0-9]*"
                    inputmode="numeric">
                <span class="opacity-percent">%</span>
            </div>


            <!-- ---------------------------------------------------------- -->
            <!-- Border color Section -->
            <!-- ---------------------------------------------------------- -->
    
            <div class="section-header">
                <h4 class="section-title">Border color</h4>
                <mat-icon class="collapse-icon" svgIcon="remove" aria-hidden="true"></mat-icon>
            </div>

            <div class="color-control-group">
                <div class="color-swatch-wrapper">
                    <input type="color" 
                        class="color-swatch" 
                        [value]="getBaseColorForPicker('border')"
                        (input)="onColorInput($event, 'border', note.borderOpacity)"
                        (change)="onColorChange($event, 'border', note.borderOpacity)">
                </div>
                <div class="slider-wrapper">
                    <input type="range" 
                        class="opacity-slider" 
                        min="0" 
                        max="100" 
                        [(ngModel)]="note.borderOpacity"
                        (input)="onFormatChange()">
                </div>
                <input type="text" 
                    class="opacity-input" 
                    [ngModel]="note.borderOpacity"
                    (ngModelChange)="onOpacityInputChange('border', $event)"
                    (input)="onOpacityInput($event, 'border')"
                    (blur)="onOpacityInputBlur('border')"
                    pattern="[0-9]*"
                    inputmode="numeric">
                <span class="opacity-percent">%</span>
            </div>

            <!-- ---------------------------------------------------------- -->
            <!-- Border thickness Section -->
            <!-- ---------------------------------------------------------- -->
            <div class="section-header">
                <h4 class="section-title">Border thickness</h4>
                <mat-icon class="collapse-icon" svgIcon="remove" aria-hidden="true"></mat-icon>
            </div>

            <div class="color-control-group">
                <div class="slider-wrapper">
                    <input type="range"
                        class="opacity-slider"
                        min="0"
                        max="20"
                        [ngModel]="note.borderWidth"
                        (ngModelChange)="onBorderWidthChange($event)">
                </div>
                <input type="text"
                    class="opacity-input"
                    [ngModel]="note.borderWidth"
                    (ngModelChange)="onBorderWidthChange($event)"
                    (input)="onBorderWidthInput($event)"
                    pattern="[0-9]*"
                    inputmode="numeric">
                <span class="opacity-percent">px</span>
            </div>
  

            <!-- ---------------------------------------------------------- -->
            <!-- Box Shadow Section -->
            <!-- ---------------------------------------------------------- -->

            <div class="section-header">
                <h4 class="section-title">Box parameters</h4>
                <mat-icon class="collapse-icon" svgIcon="remove" aria-hidden="true"></mat-icon>
            </div>

            <div class="field-box">
                <section class="disable-input-message-section">
                    <mat-checkbox 
                        [checked]="note.boxShadow"
                        (change)="onBoxShadowChange($event)">
                        Enable shadow
                    </mat-checkbox>
                </section>
            </div>
        </div>

        <!-- ---------------------------------------------------------- -->
        <!-- Save Button -->
        <!-- ---------------------------------------------------------- -->
        <!-- Pulsante Salva nascosto - salvataggio automatico con debounce -->

    </div>
</div>

<!-- Note Menu -->
<mat-menu #noteMenu="matMenu" xPosition="before" yPosition="below">
    <button mat-menu-item (click)="onDuplicateNote()">
        <mat-icon svgIcon="copy" aria-hidden="true"></mat-icon>
        <span>{{ 'Duplicate' | translate }}</span>
    </button>
    <button mat-menu-item (click)="onDeleteNote()">
        <mat-icon svgIcon="bin" aria-hidden="true"></mat-icon>
        <span>{{ 'Delete' | translate }}</span>
    </button>
</mat-menu>
