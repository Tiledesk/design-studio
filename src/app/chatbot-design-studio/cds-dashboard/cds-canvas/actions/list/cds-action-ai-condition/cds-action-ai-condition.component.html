<div *ngIf="previewMode" class="cds-action-preview" style="position: relative;">


    <div class="action-row">
        <div id="gpt-icon" class="action-row-left icon-action">
            <mat-icon *ngIf="!action?.llm" svgIcon="add_ai_model" aria-hidden="true"></mat-icon>
            <img *ngIf="action?.llm && (llm_models | find:{key: 'value', value: action?.llm})" 
                 src="{{ (llm_models | find:{key: 'value', value: action?.llm }).src }}" 
                 alt="">
        </div>
        <div class="action-row-right">
            <div *ngIf="action?.llm && (llm_models | find:{key: 'value', value: action?.llm})" class="action-row-right">
                {{ (llm_models | find:{key: 'value', value: action?.llm }).name }} <span *ngIf="action?.model">({{action?.model}})</span>
            </div>
            <div *ngIf="!action?.llm || !(llm_models | find:{key: 'value', value: action?.llm})" class="action-row-right empty">
                {{'CDSCanvas.ChooseTheAIModel' | translate }}
            </div>
        </div>
    </div>



    <div *ngFor="let intent of action.intents; let i = index">
        <div class="action-row">
            <div class="intent-preview-info">
                <div class="intent-prompt-preview" *ngIf="intent.prompt">
                    <span class="prompt-text">{{intent.prompt}}</span>
                </div>
                <div class="intent-prompt-preview empty" *ngIf="!intent.prompt">
                    <span class="prompt-text">No prompt defined</span>
                </div>
            </div>
        </div>
        <div *ngIf="intent.label" class="previewContent">
            <!-- <div class="icon-action">
                <img class="active-icon" src="assets/images/icons/if_condition.svg">
            </div>
            <label class="title-preview-label">{{'CDSCanvas.Success' | translate }}</label> -->
            <cds-connector class="connector-true"
                 [idConnector]   = "listOfConnectors[intent.label]?.idConnector"    
                 [idConnection]  = "listOfConnectors[intent.label]?.idConnection"
                 [isConnected]   = "listOfConnectors[intent.label]?.isConnected">
            </cds-connector>
        </div>
        <hr class="preview-divider">
    </div>


    <div class="add-intent-container">
         <button class="btn btn-secondary add-intent-btn" 
                 type="button" 
                 (click)="$event.stopPropagation();addNewCondition()">
             <span class="material-icons">add</span>
             Add Condition
         </button>
     </div>
     
    <!-- <hr class="preview-divider"> -->


    <div class="previewContent">
        <!-- {{'CDSCanvas.Fallback' | translate }} -->
       <label class="title-preview-label">Fallback</label>
        <cds-connector class="connector-false"
            [idConnector]   = "idConnectorFallback"
            [idConnection]  = "idConnectionFallback"
            [isConnected]   = "isConnectedFallback">
        </cds-connector>
    </div>

    <!-- <hr class="preview-divider"> -->

    <div class="previewContent">
       <label class="title-preview-label">{{'CDSCanvas.Error' | translate }}</label>
        <cds-connector class="connector-false"
            [idConnector]   = "idConnectorError"
            [idConnection]  = "idConnectionError"
            [isConnected]   = "isConnectedError">
        </cds-connector>
    </div>

</div>


<div id="scrollMe" #scrollMe *ngIf="!previewMode && !showVariablesSection" class="content-panel-intent-detail no-footer">


    <!-- AI Condition Component -->
    <div class="field-box">
        <div *ngFor="let intent of action.intents; let i = index">
             <app-ai-condition 
                [index]="i" 
                [intent]="intent"
                [listOfIntents]="listOfIntents"
                (updateAndSaveConnectors)="onUpdateAndSaveConnectors(intent, $event.type)"
                (updateAndSaveAction)="onUpdateAndSaveAction(intent)"
                (deleteCondition)="onDeleteCondition($event)">
             </app-ai-condition>
         </div>

    </div>
    
    <!-- Add New Intent Button -->
    <div class="add-intent-container">
         <button class="btn btn-secondary add-intent-btn" 
                 type="button" 
                 (click)="$event.stopPropagation();addNewCondition()">
             <span class="material-icons">add</span>
             Add Condition
         </button>
    </div>

    <div class="ai-condition-instructions">
        <div class="condition-header">
            <label class="condition-number">Instructions</label>
        </div>
        <cds-textarea id="instructions" 
            [emojiPikerBtn]="false" 
            [setAttributeBtn]="true" 
            [limitCharsText]="100000"
            [minRow]="4"[maxRow]="25" 
            [text]="action.instructions" 
            [placeholder]="placeholder"
            (blur)="onBlur($event)"
            (changeTextarea)="onChangeTextarea($event, '', 'instructions')"
            >
            <!--  -->
        </cds-textarea>
    </div>

    <div class="answer-preview" *ngIf="showPreview">
        <div class="header-answer-preview">
            <div class="label-and-button-container">
                <label class="title-label">{{'CDSCanvas.AnswerPreview' | translate }}
                    <span class="subtitle-label" *ngIf="llm_models | find:{key: 'value', value: action?.llm}">
                        ( {{'CDSCanvas.GeneratedWith' | translate }}  {{ (llm_models | find:{key: 'value', value: action?.llm }).name }} )
                    </span>
                </label>
            </div>
        </div>

        <div id="preview-container" class="preview-container">

            <div class="placeholder-container" *ngIf="searching">
                <loading-spinner class="custom-spinner"></loading-spinner>
                <span style="margin-left: 8px;">{{'CDSCanvas.GeneratingAnswer' | translate}} ...</span>
            </div>

            <div *ngIf="!searching && !showAiError && ai_response?.answer">
                {{ ai_response?.answer }}
            </div>

            <div *ngIf="showAiError">
                {{ ai_error }}
            </div>

        </div>

    </div>

    <mat-accordion>
        <mat-expansion-panel (opened)="panelOpenState = true" (closed)="panelOpenState = false"
            class="custom-expansion-panel">
            <mat-expansion-panel-header class="disable_ripple">
                <mat-panel-title>
                    {{'CDSCanvas.AISettings' | translate }}
                </mat-panel-title>
            </mat-expansion-panel-header>
            <div>


                 <!-- // llm select -->
                 <div class="field-box">
                    <label class="title-label">{{'CDSCanvas.LLM' | translate }} - {{'CDSCanvas.Model' | translate }}</label>
                    <cds-select id="model-condition"
                        [class]="!llm_model_selected.configured ? 'not-configured' : ''"
                        [items]="llm_models_flat" 
                        [itemSelected]="llm_model_selected.model"
                        [bindLabelSelect]="'modelName'" 
                        [bindValueSelect]="'model'"
                        [groupByKey]="'llm'"
                        [clearable]="false" 
                        [searchable]="true"
                        [optionalBindAdditionalText]="'multiplier'" 
                        (onSelected)="onChangeSelect($event, 'llm_model')">
                    </cds-select>
                    <div class="bottom-row">
                        <div class="configure-model-button" (click)="goToIntegrations()">{{'CDSCanvas.ConfigureModel' | translate }}</div>
                    </div>
                </div>

                <!-- <div class="field-box">
                    <label class="title-label">{{'CDSCanvas.LLM' | translate }} - {{'CDSCanvas.Model' | translate }}</label>
                    <div class="select-container" [class.not-configured]="!selectedModelConfigured">
                        <cds-text id="text-label-model"
                            class="sx-input" 
                            [class]="!selectedModelConfigured ? 'not-configured' : ''"
                            [text]="labelModel"
                            [autocompleteOptions]="autocompleteOptionsFlat"
                            [placeholder]="'CDSCanvas.Model' | translate"
                            [setAttributeBtn]="false"
                            (onChange)="onChangeTextarea($event, labelModel, 'llm_model')"
                            (blur)="onBlur($event)"
                            >
                        </cds-text>
                    </div>
                    <div class="bottom-row">
                        <div class="multiplier-container"><span *ngIf="multiplier">{{multiplier}} x tokens</span></div>
                        <div class="configure-model-button" (click)="goToIntegrations()">{{'CDSCanvas.ConfigureModel' | translate }}</div>
                    </div>
                </div> -->

                
                <!-- // llm select -->
                <!-- <div class="field-box">
                    <label class="title-label">{{'CDSCanvas.LLM' | translate }}</label>
                    <cds-select id="model-condition"
                        [items]="llm_models" 
                        [itemSelected]="action.llm"
                        [bindLabelSelect]="'name'" 
                        [bindValueSelect]="'value'"
                        [placeholder]="'CDSCanvas.SelectLL' | translate"
                        (onSelected)="onChangeSelect($event, 'llm')">
                    </cds-select>
                </div> -->

                <!-- <div class="field-box">
                    <label class="title-label">{{'CDSCanvas.Model' | translate }}</label>
                    <cds-text id="text"
                        class="sx-input" 
                        [text]="actionLabelModel"
                        [placeholder]="'CDSCanvas.Model' | translate"
                        [autocompleteOptions]="autocompleteOptions"
                        (onOptionSelected)="onOptionSelected($event, 'model')"
                        (blur)="onBlur($event)"
                        (onChange)="onChangeTextarea($event, actionLabelModel, 'model')">
                    </cds-text>
                </div> -->





                <!-- // max_tokens slider -->
                <div class="field-box">
                    <label class="title-label">{{'CDSCanvas.MaxTokens' | translate }}</label>
                    <div class="action-wait-content">

                        <div class="action-wait-slider">
                            <div class="action-wait-range">{{ai_setting['max_tokens'].min}}</div>
                            <mat-slider 
                                class="wait-slider" thumbLabel 
                                [displayWith]="formatSliderLabel"
                                [step]="ai_setting['max_tokens'].step"  
                                [min]="ai_setting['max_tokens'].min"
                                [max]="ai_setting['max_tokens'].max"
                                [(ngModel)]="action.max_tokens"
                                (change)="updateSliderValue($event.value, 'max_tokens')" 
                                aria-label="units">
                            </mat-slider>
                            <div class="action-wait-range">{{ai_setting['max_tokens'].max | formatNumber}}</div>
                        </div>
                        <!-- // doesn't work propely -->
                        <!-- <cds-text [text]="action.max_tokens.toString()" [inputType]="'number'" [maxlength]="3" [min]="1" [max]="512" (onChange)="updateSliderValue($event, 'max_tokens')" class="slider-input"></cds-text> -->
                        <input type="number" 
                               class="slider-input gpt-setting-input" 
                               [(ngModel)]="action.max_tokens"
                               [min]="ai_setting['max_tokens'].min"
                               [max]="ai_setting['max_tokens'].max"
                               (change)="updateSliderValue(action.max_tokens, 'max_tokens')">
                        <!-- <cds-text [text]="action.max_tokens" [disabled]="true" class="slider-input"></cds-text> -->
                    </div>
                </div>

                <!-- // temperature slider -->
                <div class="text-editor-wrapper">
                    <div class="field-box">
                        <label class="title-label">{{'CDSCanvas.Temperature' | translate }}</label>
                        <div class="action-wait-content">

                            <div class="action-wait-slider" [class.disabled]="ai_setting['temperature'].disabled">
                                <div class="action-wait-range">{{ai_setting['temperature'].min}}</div>
                                <mat-slider 
                                    class="wait-slider" thumbLabel
                                    [step]="ai_setting['temperature'].step"  
                                    [min]="ai_setting['temperature'].min"
                                    [max]="ai_setting['temperature'].max" 
                                    [disabled]="ai_setting['temperature'].disabled"
                                    [(ngModel)]="action.temperature"
                                    (change)="updateSliderValue($event.value, 'temperature')" aria-label="units">
                                </mat-slider>
                                <div class="action-wait-range">{{ai_setting['temperature'].max}}</div>
                            </div>
                            <!-- // doesn't work propely -->
                            <!-- <cds-text [text]="action.temperature.toString()" [inputType]="'number'" [maxlength]="4" [min]="0" [max]="1" (onChange)="updateSliderValue($event, 'temperature')" class="slider-input"></cds-text> -->
                            <input type="number" class="slider-input gpt-setting-input" value="{{action.temperature}}" disabled>
                        </div>
                    </div>
                </div>

                <!-- // system context textarea -->
                <div class="field-box">
                    <label class="title-label">{{'CDSCanvas.SystemContext' | translate }}</label>
                    <cds-textarea id="context"
                        [emojiPikerBtn]="false" 
                        [limitCharsText]="100000"
                        [minRow]="1" [maxRow]="5" 
                        [text]="action.context" 
                        [placeholder]="'CDSCanvas.YouAreAwesomeAssistant' | translate"
                        (blur)="onBlur($event)"
                        (changeTextarea)="onChangeTextarea($event, $event, 'context')">
                    </cds-textarea>
                </div>

            </div>
        </mat-expansion-panel>
    </mat-accordion>

    <hr class="custom-divider" style="margin-top: 10px;">

    <div class="link-container" *ngIf="projectPlan === PLAN_NAME.G">
        <a class="link" (click)="goToIntegrations()">{{'CDSCanvas.ManageIntegrationKey' | translate }}</a>
    </div>

    <div class="field-box">
        <label class="title-label">{{'CDSCanvas.GPTReply' | translate }}</label>
        <cds-textarea 
            id="assignTo" 
            [textLimitBtn]="false" 
            [emojiPikerBtn]="false" 
            [setAttributeBtn]="true"
            [isLiquidjs]="false"
            [minRow]="1" [maxRow]="1" 
            [readonly]="true" 
            [text]="action.assignReplyTo"
            (selectedAttribute)="onSelectedAttribute($event, 'assignReplyTo')"
            (clearSelectedAttribute)="onSelectedAttribute($event, 'assignReplyTo')">
        </cds-textarea>
    </div>

    <div class="field-box">
        <label class="subtitle-label">{{'CDSCanvas.ErrorAutomaticAssign' | translate }}
            <b>flowError</b>
        </label> 
    </div>

    
    <hr class="custom-divider">

    <div class="field-box">
        <div class="condition-container">
            <!-- {{'CDSCanvas.Fallback' | translate | titlecase}} -->
            <label class="condition-text">Fallback</label>
        </div>
        <cds-select id="text-condition" 
            [items]="listOfIntents" 
            [bindLabelSelect]="'name'"
            [bindValueSelect]="'value'" 
            [itemSelected]="action?.fallbackIntent" 
            [placeholder]="'CDSCanvas.SelectABlock' | translate"
            [clearable]="true" 
            (onSelected)="onChangeBlockSelect($event, 'fallbackIntent')"
            (onReset)="onResetBlockSelect($event, 'fallbackIntent')">
        </cds-select>
    </div>

    <hr class="custom-divider">

    <div class="field-box">
        <div class="condition-container">
            <label class="condition-text">{{'CDSCanvas.Error' | translate | titlecase}}</label>
        </div>
        <cds-select id="text-condition" 
            [items]="listOfIntents" 
            [bindLabelSelect]="'name'"
            [bindValueSelect]="'value'" 
            [itemSelected]="action?.errorIntent" 
            [placeholder]="'CDSCanvas.SelectABlock' | translate"
            [clearable]="true" 
            (onSelected)="onChangeBlockSelect($event, 'errorIntent')"
            (onReset)="onResetBlockSelect($event, 'errorIntent')">
        </cds-select>
    </div>

</div>
