<!-- dragDisabled: true -->
<div #resizeElement class="panel-intent-content tds_draggable"
    (mousedown)="onIntentMouseDown($event)"
    (mouseenter)="onIntentMouseEnter($event)"
    (mouseleave)="onIntentMouseLeave($event)"
    (click)="$event.stopPropagation();onOpenIntentPanel(intent)"
    [ngClass]="intentClasses"
    [id]="intentContentId"
    [ngStyle]="{
        'background-color': backgroundColor,
        'outline': outlineStyle
      }">
     
    <!-- <span class="panel-intent-content tds_draggable intent-background-overlay"></span> -->

    <!-- OTTIMIZZATO: Espressione precomputata invece di valutazione nel template (evita chiamate a metodo e valutazioni complesse) -->
    <cds-connector-in *ngIf="showConnectorIn"
        [connectorsIn]="connectorsIn">
    </cds-connector-in>

    <div class="header-draggable tds_draggable"></div>
    
    <!-- OTTIMIZZATO: *ngIf per nascondere durante drag/pan, valori precomputati per evitare valutazioni nel template -->
    <cds-panel-intent-controls *ngIf="showIntentControls"
        [isInternalIntent]="isInternalIntent"
        [display_name]="displayName"
        [deleteOptionEnabled]="deleteOptionEnabled"
        [webhookEnabled]="webhookEnabled"
        (optionClicked)="onOptionClicked($event)">
    </cds-panel-intent-controls>

    <!-- OTTIMIZZATO: ID precomputato, binding classe duplicato rimosso, espressioni booleane precomputate, enum precomputati -->
    <div [id]="blockHeaderId"
        class="pic-header" 
        [ngClass]="{'cds-start': isStart}">
        
        <cds-panel-intent-header *ngIf="!isUntitledBlock" 
            class="pic-title-text tds_draggable" 
            [intentColor]="intentColor"
            [intent]="intent"
            (click)="onOptionClicked($event)">
        </cds-panel-intent-header>

        <div *ngIf="showIntentOptions" class="cds-intent-options tds_draggable">
            <div class="option" 
                (click)="onSelectQuestion(QUESTION_TYPE)"
                [attr.active]="hasQuestions">
                <img src="assets/images/brain.svg" [title]="'Question' | translate" alt="Question">
            </div>
            <div class="option" (click)="onSelectForm(FORM_TYPE)" 
                [attr.active]="hasForm">
                <img src="assets/images/form.svg" [title]="'Form' | translate" alt="Form">
            </div>
        </div>

    </div>
    
    <!-- OTTIMIZZATO: Classe precomputata invece di binding classe valutato ad ogni change detection -->
    <div *ngIf="isAgentsAvailable" class="agents-available" [ngClass]="agentsAvailableClasses"><span class="material-icons">boy</span></div>

    <!-- OTTIMIZZATO: Binding isStart eliminato (sempre true quando renderizzato per *ngIf="isStart") -->
    <div *ngIf="isStart" class="cds-start-content tds_draggable">
        <cds-action-intent class="panel-response" 
            [isStart]="true" 
            [intentSelected]="intent"
            [action]="startAction" 
            (updateAndSaveAction)="onUpdateAndSaveAction($event)">
        </cds-action-intent>
    </div>

    <!-- OTTIMIZZATO: Espressioni precomputate, logica ngClass corretta, accessi a servizio eliminati -->
    <div *ngIf="!isStart" class="actions-list-wpr"
        cdkDropList
        [cdkDropListData]="listOfActions"
        [cdkDropListDisabled]="isNewChatbot"
        (cdkDropListDropped)="onDropAction($event)"
        [cdkDropListEnterPredicate]="canEnterDropList(intent)">
        <!-- OTTIMIZZATO: Espressione booleana precomputata -->
        <div class="add--action-placeholder" *ngIf="!hasActions" 
            cdkDrag
            [cdkDragDisabled]="dragDisabled || isNewChatbot">
            <div class="add--action-placeholder-text">
                {{ 'CDSCanvas.AddAnActionToBlock' | translate}}
                <span style="display: block;font-size: 12px;">
                    {{ 'CDSCanvas.AddAnActionToBlockDescription' | translate}}
                </span>
            </div>

            <div class="csd-open-action-menu-btn-wpr">
                <div #openActionMenuBtn (click)="$event.stopPropagation();openActionMenu(intent, 'add-action-btn')"
                    class="cds-add-action-btn">    
                    + {{ 'CDSCanvas.AddAction' | translate}}
                </div>
            </div>
        </div>

        <!-- <div class="tds-drop-element tds_draggable"></div> -->

        <!-- OTTIMIZZATO: Classi e stili precomputati, accessi a servizio eliminati, logica ngClass corretta, cdkDrag disattivato durante pan/zoom -->
        <div *ngFor="let action of listOfActions; let i = index; let first = first; let last = last; trackBy: trackByActionId" 
            cdkDrag
            [cdkDragDisabled]="isPanOrZoomActive || isNewChatbot"
            (cdkDragStarted)="onDragStarted($event, intent.intent_id, i)" 
            (cdkDragReleased)="onDragEnded($event, i)"
            (cdkDragMoved)="onDragMove($event)"
            [id]="action._tdActionId" 
            class="box-action" 
            tabindex=-1
            [ngClass]="actionClasses.get(action._tdActionId || 'action-'+i)" 
            [ngStyle]="{'outline': actionOutlineStyle.get(action._tdActionId || 'action-'+i)}"
            (keydown)="onKeydown($event)" 
            (click)="onSelectAction(action, i, action._tdActionId)">
            
            <span class="action-element">

                <div *cdkDragPreview id="customDragPreview">
                    <cds-action-description 
                        class="header-action" 
                        [previewMode]="false"
                        [elementType]="action._tdActionType">
                    </cds-action-description>
                </div>
             
                <div class="action-drag-placeholder" *cdkDragPlaceholder></div>

                <cds-action-description 
                    class="header-action" 
                    cdkDragHandle
                    [elementType]="action._tdActionType">
                </cds-action-description>
                
          
                <div cdkDragDisabled class="body-action" [ngSwitch]="action._tdActionType">
                    
                    <cds-action-controls *ngIf="!isNewChatbot"
                        (onClickControl)="onClickControl($event, action, i)">
                    </cds-action-controls>
    
                    
                    <cds-action-reply *ngSwitchCase="TYPE_ACTION.REPLY" 
                        class="panel-response" 
                        [intentSelected]="intent"
                        [connector]="connector" 
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-reply>

                    <cds-action-reply-v2 *ngSwitchCase="TYPE_ACTION.REPLYV2" 
                        class="panel-response" 
                        [intentSelected]="intent"
                        [connector]="connector" 
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-reply-v2>
    
                    <cds-action-reply *ngSwitchCase="TYPE_ACTION.RANDOM_REPLY" 
                        class="panel-response"
                        [intentSelected]="intent" 
                        [connector]="connector" 
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-reply>
    
                    <cds-action-intent *ngSwitchCase="TYPE_ACTION.INTENT" 
                        class="panel-response" 
                        [intentSelected]="intent"
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-intent>

                    <cds-action-connect-block *ngSwitchCase="TYPE_ACTION.CONNECT_BLOCK" 
                        class="panel-response" 
                        [intentSelected]="intent"
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-connect-block>
    
                    <cds-action-email *ngSwitchCase="TYPE_ACTION.EMAIL" 
                        class="panel-response" 
                        [action]="action">
                    </cds-action-email>
    
                    <cds-action-online-agents *ngSwitchCase="TYPE_ACTION.ONLINE_AGENTS" 
                        class="panel-response"
                        [connectorChanged]="connectorChanged" 
                        [intentSelected]="intent" 
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-online-agents>

                    <cds-action-online-agents-v2 *ngSwitchCase="TYPE_ACTION.ONLINE_AGENTSV2" 
                        class="panel-response"
                        [connectorChanged]="connectorChanged" 
                        [intentSelected]="intent" 
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-online-agents-v2>
    
                    <cds-action-open-hours *ngSwitchCase="TYPE_ACTION.OPEN_HOURS" 
                        class="panel-response"
                        [connectorChanged]="connectorChanged" 
                        [intentSelected]="intent" 
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-open-hours>
    
                    <cds-action-agent *ngSwitchCase="TYPE_ACTION.AGENT" 
                        class="panel-response" 
                        [action]="action">
                    </cds-action-agent>
    
                    <cds-action-wait *ngSwitchCase="TYPE_ACTION.WAIT" 
                        class="panel-response" 
                        [action]="action">
                    </cds-action-wait>
    
                    <cds-action-change-department *ngSwitchCase="TYPE_ACTION.CHANGE_DEPARTMENT" 
                        class="panel-response"
                        [action]="action">
                    </cds-action-change-department>
    
                    <cds-action-close *ngSwitchCase="TYPE_ACTION.CLOSE" 
                        [action]="action">
                    </cds-action-close>
    
                    <cds-action-json-condition *ngSwitchCase="TYPE_ACTION.JSON_CONDITION" 
                        class="panel-response"
                        [intentSelected]="intent" 
                        [action]="action" 
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-json-condition>
    
                    <cds-action-replace-bot *ngSwitchCase="TYPE_ACTION.REPLACE_BOT" 
                        class="panel-response"
                        [action]="action">
                    </cds-action-replace-bot>
    
                    <cds-action-replace-bot-v2 *ngSwitchCase="TYPE_ACTION.REPLACE_BOTV2" 
                        class="panel-response"
                        [action]="action">
                    </cds-action-replace-bot-v2>

                    <cds-action-replace-bot-v3 *ngSwitchCase="TYPE_ACTION.REPLACE_BOTV3" 
                        class="panel-response"
                        [action]="action">
                    </cds-action-replace-bot-v3>

                    <cds-action-assign-variable *ngSwitchCase="TYPE_ACTION.ASSIGN_VARIABLE" 
                        class="panel-response"
                        [action]="action">
                    </cds-action-assign-variable>

                    <cds-action-assign-variable-v2 *ngSwitchCase="TYPE_ACTION.ASSIGN_VARIABLE_V2" 
                        class="panel-response"
                        [action]="action">
                    </cds-action-assign-variable-v2>
    
                    <cds-action-delete-variable *ngSwitchCase="TYPE_ACTION.DELETE_VARIABLE" 
                        class="panel-response"
                        [action]="action">
                    </cds-action-delete-variable>
    
                    <cds-action-hide-message *ngSwitchCase="TYPE_ACTION.HIDE_MESSAGE" 
                        class="panel-response"
                        [action]="action" 
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-hide-message>
    
                    <cds-action-web-request *ngSwitchCase="TYPE_ACTION.WEB_REQUEST"     
                        class="panel-response"
                        [action]="action">
                    </cds-action-web-request>
    
                    <cds-action-web-request-v2 *ngSwitchCase="TYPE_ACTION.WEB_REQUESTV2"    
                        class="panel-response"
                        [intentSelected]="intent" 
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-web-request-v2>

                    <cds-action-web-response *ngSwitchCase="TYPE_ACTION.WEB_RESPONSE"    
                        class="panel-response"
                        [intentSelected]="intent" 
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-web-response>
    
                    <cds-action-whatsapp-attribute *ngSwitchCase="TYPE_ACTION.WHATSAPP_ATTRIBUTE" 
                        class="panel-response"
                        [action]="action">
                    </cds-action-whatsapp-attribute>
    
                    <cds-action-whatsapp-static *ngSwitchCase="TYPE_ACTION.WHATSAPP_STATIC" 
                        class="panel-response"
                        [action]="action">
                    </cds-action-whatsapp-static>
    
                    <cds-action-add-kb-content *ngSwitchCase="TYPE_ACTION.KB_CONTENT"
                        class="panel-response"
                        [intentSelected]="intent"
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-add-kb-content>

                    <cds-action-askgpt *ngSwitchCase="TYPE_ACTION.ASKGPT" 
                        class="panel-response" 
                        [intentSelected]="intent" 
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-askgpt>

                    <cds-action-askgpt-v2 *ngSwitchCase="TYPE_ACTION.ASKGPTV2" 
                        class="panel-response" 
                        [intentSelected]="intent" 
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-askgpt-v2>
    
                    <cds-action-gpt-task *ngSwitchCase="TYPE_ACTION.GPT_TASK" 
                        class="panel-response" 
                        [intentSelected]="intent"
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-gpt-task>

                    <cds-action-gpt-assistant *ngSwitchCase="TYPE_ACTION.GPT_ASSISTANT" 
                        class="panel-response" 
                        [intentSelected]="intent"
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-gpt-assistant>
    
                    <cds-action-ai-prompt *ngSwitchCase="TYPE_ACTION.AI_PROMPT" 
                        class="panel-response" 
                        [intentSelected]="intent"
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-ai-prompt>

                    <cds-action-ai-condition *ngSwitchCase="TYPE_ACTION.AI_CONDITION" 
                        class="panel-response" 
                        [intentSelected]="intent"
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-ai-condition>

                    <cds-action-capture-user-reply *ngSwitchCase="TYPE_ACTION.CAPTURE_USER_REPLY" 
                        class="panel-response" 
                        [intentSelected]="intent"
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-capture-user-reply>
                    
                    <cds-action-qapla *ngSwitchCase="TYPE_ACTION.QAPLA" 
                        class="panel-response"
                        [intentSelected]="intent" 
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-qapla>

                    <cds-action-make *ngSwitchCase="TYPE_ACTION.MAKE"    
                        class="panel-response"
                        [intentSelected]="intent" 
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-make>

                    <cds-action-hubspot *ngSwitchCase="TYPE_ACTION.HUBSPOT"    
                        class="panel-response"
                        [intentSelected]="intent" 
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-hubspot>

                    <cds-action-customerio *ngSwitchCase="TYPE_ACTION.CUSTOMERIO"    
                        class="panel-response"
                        [intentSelected]="intent" 
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-customerio>

                    <cds-action-brevo *ngSwitchCase="TYPE_ACTION.BREVO"    
                        class="panel-response"
                        [intentSelected]="intent" 
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-brevo>

                    <cds-action-n8n *ngSwitchCase="TYPE_ACTION.N8N"    
                        class="panel-response"
                        [intentSelected]="intent" 
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-n8n>

                    <cds-action-code *ngSwitchCase="TYPE_ACTION.CODE"
                        class="panel-response"
                        [intentSelected]="intent"
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-code>

                    <cds-action-add-tag *ngSwitchCase="TYPE_ACTION.ADD_TAG"
                        class="panel-response"
                        [intentSelected]="intent"
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-add-tag>
                    
                    <cds-action-lead-update *ngSwitchCase="TYPE_ACTION.LEAD_UPDATE" 
                        class="panel-response"
                        [intentSelected]="intent" 
                        [action]="action" 
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-lead-update>

                    <cds-action-clear-transcript *ngSwitchCase="TYPE_ACTION.CLEAR_TRANSCRIPT" 
                        [action]="action">
                    </cds-action-clear-transcript>

                    <cds-action-move-unassigned *ngSwitchCase="TYPE_ACTION.MOVE_TO_UNASSIGNED" 
                        [action]="action">
                    </cds-action-move-unassigned>

                    <cds-action-dtmf-form *ngSwitchCase="TYPE_ACTION_VXML.DTMF_FORM"    
                        class="panel-response"
                        [intentSelected]="intent" 
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-dtmf-form>

                    <cds-action-dtmf-menu *ngSwitchCase="TYPE_ACTION_VXML.DTMF_MENU"    
                        class="panel-response"
                        [intentSelected]="intent" 
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-dtmf-menu>

                    <cds-action-blind-transfer *ngSwitchCase="TYPE_ACTION_VXML.BLIND_TRANSFER"    
                        class="panel-response"
                        [intentSelected]="intent" 
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-blind-transfer>

                    <cds-action-play-prompt *ngSwitchCase="TYPE_ACTION_VXML.PLAY_PROMPT"    
                        class="panel-response"
                        [intentSelected]="intent" 
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-play-prompt>

                    <cds-action-speech-form *ngSwitchCase="TYPE_ACTION_VXML.SPEECH_FORM"    
                        class="panel-response"
                        [intentSelected]="intent" 
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-speech-form>
                    

                    <cds-action-send-whatsapp *ngSwitchCase="TYPE_ACTION.SEND_WHATSAPP" 
                        class="panel-response"
                        [intentSelected]="intent" 
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-send-whatsapp>

                    <cds-action-record *ngSwitchCase="TYPE_ACTION_VXML.AUDIO_RECORD"    
                        class="panel-response"
                        [intentSelected]="intent" 
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-record>

                    <cds-action-flow-log *ngSwitchCase="TYPE_ACTION.FLOW_LOG"
                        class="panel-response"
                        [intentSelected]="intent"
                        [action]="action"
                        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
                    </cds-action-flow-log>
                   
                </div>
              
            </span>
            
           

       
            <cds-action-arrow *ngIf="(listOfActions?.length-1) > i" 
                id="action-arrow-{{i}}"
                class="cds-action-arrow">
            </cds-action-arrow> 
        
            


        </div>
        
    </div>
    
    <cds-action-intent *ngIf="!isStart && intent && actionIntent && !isActionIntent"
        class="panel-response last-action-intent" 
        [intentSelected]="intent"
        [action]="actionIntent"
        [isLast]="true"
        (updateAndSaveAction)="onUpdateAndSaveAction($event)">
    </cds-action-intent>

    <div class="footer-intent">
        <div *ngIf="!isStart && listOfActions?.length > 0 && !isNewChatbot" class="csd-open-action-menu-btn-wpr">
            <div #openActionMenuBtn (click)="$event.stopPropagation();openActionMenu(intent, 'add-action-btn')"
                class="cds-add-action-btn">    
                + {{ 'CDSCanvas.AddAction' | translate}}
            </div>
        </div>
    </div>
    


   

</div>